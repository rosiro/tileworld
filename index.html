<!doctype html>
<html lang="ja">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="static/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body {
          color:white;
          background-color:black;
      }
      .block {
          width:36px;
          height:36px;
          margin:10px;
          float:left;
      }
      .block_mini {
          width:18px;
          height:18px;
          margin-top:4px;
          margin-left:6px;
          float:left;
      }
      // field
      .glass {
          background-color:#46c940;
          display:block;
          text-align:center;
      }
      .wheat {
          background-color:#bdb35e;
          display:block;
          text-align:center;
      }
      .tree {
          background-color:#0a9b03;
          display:block;
          text-align:center;
      }
      .soil {
          background-color:#c4906a;
          display:block;
          text-align:center;
      }
      .wood {
          background-color:#c4906a;
          display:block;
          text-align:center;
      }
      .sand {
          background-color:#bdb35e;
          display:block;
          text-align:center;
      }
      .clay {
          background-color:#686560;
          display:block;
          text-align:center;
      }
      .coal {
          background-color:#382c1b;
          display:block;
          text-align:center;
      }
      .rock {
          background-color:#6d532d;
          display:block;
          text-align:center;
      }
      .iron {
          background-color:#6d532d;
          display:block;
          text-align:center;
      }
      .silver {
          background-color:#dedede;
          display:block;
          text-align:center;
      }
      .gold {
          background-color:#ffe408;
          display:block;
          text-align:center;
      }
      .glass {
          background-color:green;
          display:block;
          text-align:center;
      }
      .umi {
          background-color:blue;
          display:block;
          text-align:center;
      }
      .yama {
          background-color: darkgreen;
          display:block;
          text-align:center;
      }
      .blockClickanim {
          animation-name: colortowhite;
          animation-duration: 4s;
          border: 1px solid;
      }
      .area {
          clear:both;
      }
      @keyframes colortowhite {
          to { border-width: 4px; border-color: white;}
      }
    </style>
    <title>TITLE</title>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <h1>test game</h1>
        <div id="debug" class="col-md-12"></div>
        <div class="col-md-9">
          <div id="field" class="area"></div>
          <div id="human" class="area"><h2>人</h2></div>
          <div id="animal" class="area"><h2>動物</h2></div>

          <br clear="all">
          <div id="building"><h2>建造物</h2></div>

          <br clear="all">
          <div id="TODO">
            <h2>TODO</h2>
            <ul>
              <li>野生植物の自然増の実装</li>
              <li>人の実装</li>
              <li>動物の実装</li>
              <li><s>収穫物の確率処理</s></li>
            </ul>
          </div>
        </div>
        <div id="resource_status" class="col-md-3"></div>
      </div>
      <div id="footer">
        version <span id="version"></span>
      </div>
    </div>
    <script src="static/js/bootstrap.bundle.min.js"></script>
    <script src="static/js/jquery-3.6.0.min.js"></script>
    <script>
      const VERSION = '2021.12.2';
      var resource = {
          "glass": {
              "name_ja" : '草', "name_en" : 'glass', "show": true, "field" : true, "type": "field", "level": 1, "time": 1000, "next": 10, "value": 0, nis: 0.01,
              "gets": [ { 'item': 'wheat', val: 1, probability: 50 }, { 'item': 'soil', val: 1, probability: 50 } ],
              "nexts": [ { 'item': "yama", val: 0 }, { 'item': "umi", val: 0 } ],
          },
          "tree": {
              "name_ja" : '木', "name_en" : 'tree', "show": true, "field" : true, "type": "field", "level": 1, "time": 1000, "next": 10, "value": 0, nis: 0.01,
              "gets": [ { 'item': 'wood', val: 1, probability: 100 } ],
              "nexts": [ ],
          },
          "wood": {
              "name_ja" : '木材', "name_en" : 'wood', "show": true, "field" : true, "type": "field", "level": 1, "time": 1000, "next": 10, "value": 0, nis: 0,
              "gets": [ ],
              "nexts": [ ],
          },
          "wheat": {
              "name_ja" : '小麦', "name_en" : 'wheat', "show": false, "field" : true, "type": "field", "level": 1, "time": 1000, "next": 10, "value": 0, nis: 0,
              "gets": [ ],
              "nexts": [ ],
          },
          "soil": {
              "name_ja" : '土', "name_en" : 'soil', "show": true, "field" : true, "type": "field", "level": 1, "time": 1000, "next": 10, "value": 0, nis: 0,
              "gets": [ { 'item': 'clay', val: 1, probability: 10 }, { 'item': 'coal', val: 1,  probability: 10 } ],
              "nexts": [ ],
          },
          "sand": {
              "name_ja" : '砂', "name_en" : 'sand', "show": true, "field" : true, "type": "field", "level": 1, "time": 1000, "next": 20, "value": 0, nis: 0,
              "gets": [  ],
              "nexts": [ ],
          },
          "clay": {
              "name_ja" : '粘土', "name_en" : 'clay', "show": false, "field" : false, "type": "field", "level": 1, "time": 1000, "next": 20, "value": 0, nis: 0,
              "gets": [  ],
              "nexts": [ ],
          },
          "rock": {
              "name_ja" : '岩', "name_en" : 'rock', "show": true, "field" : true, "type": "field", "level": 1, "time": 1000, "next": 100, "value": 0, nis: 0,
              "gets": [ { 'item': 'iron', val: 1, probability: 10 }, { 'item': 'silver', val: 1, probability: 1 }, { 'item': 'gold', val: 1, probability: 0.1 } ],
              "nexts": [ ],
          },
          "coal": {
              "name_ja" : '石炭', "name_en" : 'coal', "show": false, "field" : false, "type": "field", "level": 1, "time": 1000, "next": 20, "value": 0, nis: 0,
              "gets": [],
              "nexts": [],
          },
          "iron": {
              "name_ja" : '鉄', "name_en" : 'iron', "show": false, "field" : false, "type": "field", "level": 1, "time": 10000, "next": 30, "value": 0, nis: 0,
              "gets": [],
              "nexts": [],
          },
          "silver": {
              "name_ja" : '銀', "name_en" : 'silver', "show": false, "field" : false, "type": "field", "level": 1, "time": 10000, "next": 30, "value": 0, nis: 0,
              "gets": [],
              "nexts": [],
          },
          "gold": {
              "name_ja" : '金', "name_en" : 'gold', "show": false, "field" : false, "type": "field", "level": 1, "time": 10000, "next": 30, "value": 0, nis: 0,
              "gets": [],
              "nexts": [],
          },
          
      };

      function click_resource(target_id){
          const this_resource = resource[target_id];
          console.log(this_resource);
          if(this_resource){
              start_work_resouceget(target_id);
              setTimeout(end_work_resourceget, this_resource.time, target_id);
          }
      }

      function next_num(next, level){
          let next_num = next * level;
          return next_num 
      }

      // SHOW DISPLAY
      function show_status (){
          var status_html = '<h2>収穫物</h2>';
          for (let key in resource) {
              if(resource[key].show == true){
                  var next_val = next_num(resource[key].next, resource[key].level);
                  status_html += '<div><div class="block_mini ' + key + '"></div>' + resource[key].name_ja + ' lv:' + resource[key].level + ' : <span id="' + key + '" class="">' + resource[key].value  + ' / ' + next_val + '</span><br clear="all"></div>';
              }
          }
          $('#resource_status').html(status_html);
      }

      function add_resource_value(resource_key, add_val){
          if (resource_key in resource) {
              var now_val = Math.round((resource[resource_key].value + add_val) * 10) / 10;
              resource[resource_key].value = now_val;
              $('#' + resource_key).text(resource[resource_key].value);
          }
      }
      
      function update_resource_value (resource_key, update_val) {
          if (resource_key in resource) {
              var now_val = Math.round(update_val * 10) / 10;
              resource[resource_key].value = now_val;
              $('#' + resource_key).text(resource[resource_key].value);
          }
      }

      function animation_workfill(target_id){
          console.log(animation_workfill);
      }

      function start_work_resouceget(target_id){
          $('#' + target_id).addClass('blockClickanim');
      }

      function getRandomInt(min, max) {
          min = Math.ceil(min);
          max = Math.floor(max);
          return Math.floor(Math.random() * (max - min) + min); //The maximum is exclusive and the minimum is inclusive
      }

      function end_work_resourceget(target_id){
          console.log('end_work_resourceget + ' + target_id);
          var debug = '';
          $('#' + target_id).removeClass('blockClickanim');

          var clicked_resource = $('#' + target_id).data('resource');
          if(clicked_resource){

              // ADD VAL
              const gets = resource[clicked_resource].gets;
              gets.forEach(function(getitem){
                  let strike = 100 / getitem.probability;
                  let randomnum = getRandomInt(1,strike);
                  debug += 'getitem? ' + getitem.item + ' ' + getitem.probability + '%<br>';
                  if(randomnum == 1 || strike == 1){
                      if(resource[getitem.item].show == false ) resource[getitem.item].show = true;
                      var getitem_val = getitem.val;
                      console.log(getitem_val);
                      if(resource[getitem.item].level > 1){
                          getitem_val = getitem.val + (getitem.val * resource[getitem.item].level * 0.1);
                      }
                      add_resource_value(getitem.item, getitem_val);

                      // levelup check
                      let next_val = next_num(resource[getitem.item].next, resource[getitem.item].level);
                      if(next_val <= resource[getitem.item].value){
                          resource[getitem.item].level = resource[getitem.item].level + 1;
                          update_resource_value(getitem.item, resource[getitem.item].value - next_val);

                          // NEXT
                          const nexts = resource[clicked_resource].nexts;
                          nexts.forEach(function(nextitem){
                              var get_key = nextitem.item;
                              var get_val = nextitem.val;
                              if(get_key != target_id){
                                  update_resource_value (get_key, 0);
                                  resource[get_key].show = true;
                              }
                          });
                      }

                  }
              });
              
              
          }

          set_resource();
          show_status();
          $('#debug').html(debug);

      }
      
      function set_resource (){
          var field_html = '<h2>世界</h2>';
          for (let key in resource) {
              if(resource[key].show == true && resource[key].type == "field"){
                  field_html += '<div class="block ' + key + ' anim" id="' + key + '" onclick="click_resource(\'' + key + '\');" data-resource="' + key + '">' + resource[key].name_ja + '</div>';
              }
          }
          $('#field').html(field_html);

          var building_html = '<h2>建造物</h2>';
          for (let key in resource) {
              if(resource[key].show == true && resource[key].type == "building"){
                  building += '<div class="block ' + key + ' anim" id="' + key + '" onclick="click_resource(\'' + key + '\');" data-resource="' + key + '">' + resource[key].name_ja + '</div>';
              }
          }
          $('#building').html(building);
      }


      function natural_increase () {
          
      }






      $(function(){
          // INIT
          set_resource();
          show_status();
          setInterval(natural_increase, 1000);
          $('#version').text(VERSION);
      });
    </script>
  </body>
</html>
